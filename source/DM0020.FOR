         SUBROUTINE DM0020 ( MSW, RMSW, YALL, JALL, LOGYTR,
     *                       TOKN, TOKN1, VALLN, VALLN1, KOD,
     *                         MSWALL, RMSWAL, ADRMSW )
CXXX----KOMEKC "MS1" --> BEPC 1.1  (OT EKAP 1987 .)------------
C   OPOPAMMA:  DM0020 ( MSW, RMSW, YALL, JALL, LOGYTR,
C   -------------            TOKN, TOKN1, VALLN, VALLN1, KOD,
C                              MSWALL, RMSWAL, ADRMSW )
C   HAHAEHE:
C   -----------              MOHTOP MOEE:
C               +-----+--------------------------------------+
C               I     I                                      I
C               I T I    HAMEHOBAHE EMEHTA             I
C               I     I                                      I
C               +-----+--------------------------------------+
C               I 333 I POBO  RS-TPEP                 I
C               +-----+--------------------------------------+
C               I 334 I POBO   D-TPEP                 I
C               +-----+--------------------------------------+
C               I 335 I POBO   T-TPEP                 I
C               +-----+--------------------------------------+
C               I 360 I KOMAPATOP(1)                        I
C               +-----+--------------------------------------+
C               I 361 I KOMAPATOP(2)                        I
C               +-----+--------------------------------------+
C
C                  B ABCMOCT OT HAEH AA ZAPROS [MASPRT(28)]:
C                  BOHET CEE HK:
C
C                  A) ZAPROS = 1
C                     ----------
C                   HE EAET HEO
C
C
C                  B) ZAPROS = 2
C                     ----------
C                   HE EAET HEO
C
C                                                                      )
C                  C) ZAPROS = 3
C                     -----------
C                     OBOTC PACET HAEH BXOHX CHAOB
C                     O BECTHM BXOHM CHAAM.
C                     P TOM: FKOM = 0 - COCTOHE BXOHX
C                                          CHAOB HE MEHOC;
C                               FKOM = 1 - HA TEKEM AE COCTOHE
C                                         OHO "O" MEHTC B
C                                         B T = TX MOMEHT BPEMEH;
C                                         PEAHO B POPAMME OPEE-
C                                         ETC HX-A BOMOHO CME-
C                                         H COCTOH, ATEM TX=TN+HX;
C                                         P HX < HXMIN [MASPRT(62)]
C                                         PHMAETC HX = HXMIN;
C                                         COCTOHE HX=0.0 BBAET
C                                         EAT COOEH;
C                                         POBEEH COTBETCTBE
C                                         MEHEH B MASPRT:
C                                          FKOM <== "1"
C                                         HXG = MIN( HX, HXG )
C                                         TXG = TN + HXG
C
C
C
C                  D) ZAPROS = 4
C                     **********
C                   - P TX_G  [MASPRT(35)] .EQ. TX[RMSW(10)] -
C               ( PABEHCTBO POBEPETC C TO. O "EPSKOM"[MASPRT(39)])
C                      KCPETC CMEHA COCTOH BXOHOO CHAA,
C                      B POTBHOM CAE, HAEHE BXOHOO CHAA
C                      BOCCTAHABBAETC;
C
C   METO:         OECKOE MOEPOBAHE
C   -----
C
C   APAMETP:     MSW, RMSW - PABEE COBO COCTOH MAKPOMOE
C   ---------      ( "OTPEOK" MACCB MSWALL -> C.M. / GETMSW );
C                  YALL - MATPA P0BOMOCT AHAPEMO E;
C                  JALL - BEKTOP CTOHKOB TOKA AHAPEMO E;
C                  VALLN - BEKTOP OBX HAPEH AHAPEMO E:
C                          P  T  =  TN;
C                  VALLN1- BEKTOP OBX HAPEH AHAPEMO E:
C                          P  TN + H0;
C                  TOKN   TOKN1 - HAEHE EPEMEHHX "COCTOH"
C                                  MOE P TN    TN + H0;
C                          ( PAMEPHOCT -> CM. MASPRT(46) = NNTOK )
C                  LOGYTR - BEKTOP PHAKOB K.. OB:
C                  COETC B MAKPOMOEX C PHAKOM TA = 6;
C                  PAMEPHOC MACCBOB P "ALL" OPEETC:
C                   MAX_DIMENSION ---> NDALL = MASPRT(23)
C                   TEKA_PAMEPHOCT ---> NSYS = MASPRT(26)
C                  KOD - APAMETP OPATHO CB C MOHTOPOM DM....
C
C
C
C
C   OPOPAMM:  1. COMMON PROF1, PROF2, PROF3;
C   ------------   2. SEQSOS
C
C   PMEAHE:  1.CTPKTP MSW COBA MAKPOMOE AHHOO TA CM. HE
C   ----------   2. P ZAPROS ^=  1, 2, 3, 4 - BAA COOEH  XO
C                3. P FTEST >=1 -> EAT HA WTRE AKTA CMEH COCTOH
C
C
C                    "OCTOHHA" ACT MSW
C                     ----------------------
C
C  +-------+--------+--------+--------+------+------+-------+---+
C  I HOMEP I HOMEP  I HOMEP  I PHAKI KO I KO. IAP.   IPE I
C  I EME I TA   I /    I TA   I ECT I BB. IHA.  IE I
C  I HTA   I MOE I PACETAI MOE I BO   I HA I"TOKN" IPB I
C  I       I        I DM.....I        I OBI EH.I"TOKN1"I   I
C  +-------+--------+--------+--------+------+------+-------+---+
C  I  1    I   2    I   3    I    4   I   5  I  6   I   7   I 8 I
C  +-------+--------+--------+--------+------+------+-------+---+
C
C
C              OPMAT RMSW T # 33X  360:
C              ----------------------------
C+-----------I--------------I------I-----------------------------------
C  # COBA   I    # COBA B I KTO  I
C OT HAAA  I    OTPEKE   IOPE.I
C BCEO MSW  I    RMSW B    I      I       OOHAEHE - HAEHE
C OCAH   I    FM0016    I      I
C------------I--------------I------I-----------------------------------
C     9      I     0        I      I HOMEP A ( BCEA 0 )
C----------------------------------------------------------------------
C    10      I     1        I  DM  I  TX -BPEM BOMOHOO EPEKEH
C            I              I      I
C    11      I     2        I  DM  I  A KD =0 - BX. CHA HE MEH.
C            I              I      I          =1 - BX. CHA MEH.
C    12      I     3        I  FM  I  #1 - HOMEP EMEHTA;
C    13      I     4        I  FM  I  #CM1 - HOMEP TOKA EMEHTA #1;
C    14      I     5        I  LM  I  ATOKM1 - AP B TOKN/N1 HAEH
C            I              I      I           TOKA HOMEP #CM1
C            I              I      I           EMEHTA #1;
C    15      I     6        I  FM  I  #2 -      -"-
C    16      I     7        I  FM  I  #CM2 -      -"-
C    17      I     8        I  LM  I  ATOKM2 -    -"-
C----------------------------------------------------------------------
C  OA HA MSW --> LM<BC> = 17
C
C  HA EPEMEH. ACT --> LM<RMSW> = 8
C
C----------------------------------------------------------------------
C
C
C
C
C              OPMAT RMSW T # 335:
C              ----------------------
C+-----------I--------------I------I-----------------------------------
C  # COBA   I    # COBA B I KTO  I
C OT HAAA  I    OTPEKE   IOPE.I
C BCEO MSW  I    RMSW B    I      I       OOHAEHE - HAEHE
C OCAH   I    FM0016    I      I
C------------I--------------I------I-----------------------------------
C     9      I     0        I      I HOMEP A ( BCEA 0 )
C----------------------------------------------------------------------
C    10      I     1        I  DM  I  TX -BPEM BOMOHOO EPEKEH
C            I              I      I
C    11      I     2        I  DM  I  A KD =0 - BX. CHA HE MEH.
C            I              I      I          =1 - BX. CHA MEH.
C    12      I     3        I  FM  I  #1 - HOMEP EMEHTA;
C    13      I     4        I  FM  I  #CM1 - HOMEP TOKA EMEHTA #1;
C    14      I     5        I  LM  I  ATOKM1 - AP B TOKN/N1 HAEH
C            I              I      I           TOKA HOMEP #CM1
C            I              I      I           EMEHTA #1;
C----------------------------------------------------------------------
C  OA HA MSW --> LM<BC> = 14
C
C  HA EPEMEH. ACT --> LM<RMSW> = 5
C
C----------------------------------------------------------------------
C
C
C
C                   OPMAT RMSW T # 361:
C                   ----------------------
C+-----------I--------------I------I-----------------------------------
C  # COBA   I    # COBA B I KTO  I
C OT HAAA  I    OTPEKE   IOPE.I
C BCEO MSW  I    RMSW B    I      I       OOHAEHE - HAEHE
C OCAH   I    FM0016    I      I
C------------I--------------I------I-----------------------------------
C     9      I     0        I      I HOMEP A ( BCEA 0 )
C----------------------------------------------------------------------
C    10      I     1        I  DM  I  TX- BPEM BOMOHOO EPEKEH
C            I              I      I
C    11      I     2        I  DM  I  A KD =0 - BX. CHA HE MEH.
C            I              I      I          =1 - BX. CHA MEH.
C    12      I     3        I  FM  I  1   - HOMEP A;
C    13      I     4        I  FM  I  2   - HOMEP A;
C    14      I     5        I  FM  I  3   - HOMEP A;
C    15      I     6        I  FM  I  4   - HOMEP A;
C----------------------------------------------------------------------
C  OA HA MSW --> LM<BC> = 15
C
C  HA EPEMEH. ACT --> LM<RMSW> = 6
CZZZ-------------------------------------------------------------------
         COMMON /PROF1/ MASPRT(200)
         COMMON /PROF2/ MACTAB(800)
         COMMON /PROF3/ FUNTAB(50)
         DIMENSION MSW(*), RMSW(*), YALL(*), JALL(*), LOGYTR(*)
         DIMENSION VALLN(*), RMASPT(1), VALLN1(*), TOKN(*), TOKN1(*)
         REAL JALL, JRL, L, IRLT, IRLN
         EQUIVALENCE ( MASPRT(1), RMASPT(1) )
               DIMENSION MSWALL(*), RMSWAL(*)
               INTEGER ADRMSW
         EQUIVALENCE ( MASPRT(62), HXMIN )
         EQUIVALENCE ( MASPRT(14), NWTRE )
         EQUIVALENCE ( MASPRT(60), FTEST )
         INTEGER FTEST
         EQUIVALENCE ( ZAPROS, MASPRT(28) )
         EQUIVALENCE ( HXG,    MASPRT(61) )
         EQUIVALENCE ( NDALL,  MASPRT(23) )
         EQUIVALENCE ( TN,     MASPRT(29) )
         EQUIVALENCE ( H0,     MASPRT(30) )
         EQUIVALENCE ( H1,     MASPRT(32) )
         EQUIVALENCE ( H2,     MASPRT(33) )
         EQUIVALENCE ( FKOM,   MASPRT(34) )
         EQUIVALENCE ( TXG,    MASPRT(35) )
         EQUIVALENCE ( NTXG,   MASPRT(36) )
         EQUIVALENCE ( EPSKOM, MASPRT(39) )
         EQUIVALENCE ( ZEROCP, MASPRT(50) )
         EQUIVALENCE ( ICLOSE, MASPRT(77) )
         EQUIVALENCE ( UOPEN,  MASPRT(78) )
         REAL ICLOSE
         INTEGER FKOM, ZAPROS, TIP, SIG1, SIG11, SIG2, SIG21
C--->  KOHTPO TA
         TIP = MSW(2)
         NTIP = TIP - 332
         IF ( NTIP .GE. 1  .AND. NTIP .LE. 3 ) GO TO 11
         IF ( TIP .EQ. 360 .OR. TIP .EQ. 361 ) GO TO 11
C######################################################################
         NWTRE = MASPRT(14)
         WRITE(NWTRE,9998) MSW(1), TIP
9998     FORMAT( ' *** O. CO B DM0020 - APOC HA OCBAHE O
     =O TA ***'/
     =    ' *** EMEHT # ', I10, ' T MOE # ', I10, ' ***'//)
         CALL SUBERR(1)
         RETURN
C######################################################################
11       CONTINUE
C---> BOP PEMA:
         GO TO ( 667, 666, 600, 500       ), ZAPROS
C===> HAE OKA
         NWTRE = MASPRT(14)
         WRITE(NWTRE,9997) MSW(3), ZAPROS
9997     FORMAT( ' *** DM MOHTOP #', I4, ' APOC OCBAH OOEH
     = ***'/ ' *** ZAPROS = ', I5, ' - HOPPETC ***')
         RETURN
C======================================================================
C---------------Z A P R O S = 1----------------------------------------
667      CONTINUE
         KOD = 0
         RETURN
C======================================================================
C---------------Z A P R O S = 2----------------------------------------
666      CONTINUE
C---> "CPOC" HAEH TX - BOMOHOO BPEMEH EPEKEH.....
         RMSW(10) = TN + H0
         MSW(11) = 0
         KOD = 0
         RETURN
C$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
C---- Z A P R O S = 3 -----TOKN, TOKN1, VALLN, VALLN1 OPEEEH-------
600      CONTINUE
C==>  TO A T?
         GO TO ( 610 , 620 , 630 ), NTIP
         IF( TIP .EQ. 360 ) GO TO 640
         IF( TIP .EQ. 361 ) GO TO 650
C-->  OKA. KOHAEM...
         CALL SUBERR(TIP)
         RETURN
C######################################################################
610      CONTINUE
C======================================================================
C     POBO RS-TPEP
C----------------------------------------------------------------------
         SIG1 = IFIX( TOKN ( MSW(14) ) + 0.5 )
         SIG11= IFIX( TOKN1( MSW(14) ) + 0.5 )
         TIME1 = TOKN1( MSW(14) + 3 - MSW(13) )
         SIG2 = IFIX( TOKN ( MSW(17) ) + 0.5 )
         SIG21= IFIX( TOKN1( MSW(17) ) + 0.5 )
         TIME2 = TOKN1( MSW(17) + 3 - MSW(16) )
         IF( SIG1 .EQ. SIG11 .AND. SIG2 .EQ. SIG21 ) GO TO 617
C---> AMEMC BXOHM CHAOM...
         IF( TIME1 .GT. TIME2 ) GO TO 615
C----------------------------------------------------------------------
C---> CHA HA BXOE  "S" MEHETC PAHE.
         TIME = TIME1
         IF( SIG2 .EQ.   1   ) GO TO 663
         GO TO 662
615     CONTINUE
C----------------------------------------------------------------------
C---> CHA HA BXOE  "R" MEHETC PAHE.
         TIME = TIME2
         IF( SIG1 .EQ.   1   ) GO TO 662
         GO TO 663
C----------------------------------------------------------------------
617      CONTINUE
         IF( SIG1 .EQ. 1 ) GO TO 618
         IF( SIG2 .EQ. 0 ) GO TO 661
         GO TO 663
618      CONTINUE
         IF( SIG2 .EQ. 1 ) GO TO 661
         GO TO 662
C######################################################################
620      CONTINUE
C======================================================================
C     POBO D-TPEP
C----------------------------------------------------------------------
         SIG1 = IFIX( TOKN ( MSW(14) ) + 0.5 )
         SIG11= IFIX( TOKN1( MSW(14) ) + 0.5 )
         TIME1 = TOKN1( MSW(14) + 3 - MSW(13) )
         SIG2 = IFIX( TOKN ( MSW(17) ) + 0.5 )
         SIG21= IFIX( TOKN1( MSW(17) ) + 0.5 )
         TIME2 = TOKN1( MSW(17) + 3 - MSW(16) )
C---> AMEMC BXOHM CHAOM...
         IF( TIME1 .GT. TIME2 ) GO TO 625
C---> CHA HA BXOE  "D" MEHETC PAHE.
         TIME = TIME1
         IF( SIG2 .EQ. 0 ) GO TO 661
         IF( SIG11.EQ. 0 ) GO TO 663
         GO TO 662
625     CONTINUE
C---> CHA HA BXOE  "C" MEHETC PAHE.
         TIME = TIME2
         IF( SIG21.EQ. 0 ) GO TO 661
         IF( SIG1 .EQ. 0 ) GO TO 663
         GO TO 662
C######################################################################
630      CONTINUE
C======================================================================
C     POBO T-TPEP
C----------------------------------------------------------------------
         SIG1 = IFIX( TOKN ( MSW(14) )  )
         SIG11= IFIX( TOKN1( MSW(14) )  )
         TIME = TOKN1( MSW(14) + 3 - MSW(13) )
C---> AMEMC BXOHM CHAOM...
         IF( SIG1 .EQ. 0 ) GO TO 661
         IF( SIG11.EQ. 1 ) GO TO 661
         ITOK = MSW(7)
         IF( TOKN(ITOK) .LE. 0.5 ) GO TO 662
         GO TO 663
C######################################################################
640      CONTINUE
C======================================================================
C     KOMAPATOP(1)
C----------------------------------------------------------------------
         SIGIN = TOKN( MSW(14) )
         SIGIN1= TOKN1( MSW(14) )
         SIGPR = TOKN ( MSW(17) )
         SIGPR1= TOKN1( MSW(17) )
641      CONTINUE
C---> AMEMC BXOHM CHAOM...
C----OPEEM BXOHE CHA  (?)------------------------------------
C     COEM HEH APOKCMA CHOB HA PMOM (PR)
C      HBEPCHOM (IN) BXOAX KOMAPATOPA  HAXOM BPEM COBAEH
C     TX CHAOB.
C         SIGPR = A * T + B
C         SIGIN = C * T + D
C----------------------------------------------------------------------
          A = (SIGPR1 - SIGPR) / H0
          C = (SIGIN1 - SIGIN) / H0
          IF( A .EQ. C ) GO TO 661
          B = SIGPR
          D = SIGIN
          HX = ( D - B ) / ( A - C )
          IF( HX .LT. 0.0  .OR.  HX .GE. H0 ) GO TO 661
C-->  HA AE OHO POOT MEHEHE CHAA.
          IF( HX .LT. HXMIN ) HX = HXMIN
          RMSW(10) = TN + HX
          MSW(11)  = 1
C--->  EC TX .LT. TX_G  ==> TO B TX_G  <=== TX...
         HXG  =  AMIN1( HX, HXG )
C                ****************
         TXG = TN + HXG
C====>  OTMETT TO B "FKOM"....
         FKOM = 1
C--->   PACTAT  AOMHT BXOHO CHA  BPEM EO OBEH
         ITOK = MSW(7)
         TOKN1(ITOK) = 0.0
         IF( SIGIN1 .GE. SIGPR1 ) TOKN1(ITOK) = 1.0
         TOKN1(ITOK+1) = 0.0
         IF( TOKN1(ITOK) .LE. 0.5 ) TOKN1(ITOK+1) = 1.0
         TOKN1(ITOK+2) = TN + HX
         KOD = 0
         RETURN
C######################################################################
650      CONTINUE
C======================================================================
C     KOMAPATOP(2)
C----------------------------------------------------------------------
         NY1 = MSW(12)
         NY2 = MSW(13)
         NY3 = MSW(14)
         NY4 = MSW(15)
C--> OPEEM BXOHE HAPEH   T=TN
         VNY1 = 0.0
         IF( NY1 .GT. 0 ) VNY1 = VALLN(NY1)
         VNY2 = 0.0
         IF( NY2 .GT. 0 ) VNY2 = VALLN(NY2)
         SIGIN = VNY1 - VNY2
         VNY3 = 0.0
         IF( NY3 .GT. 0 ) VNY3 = VALLN(NY3)
         VNY4 = 0.0
         IF( NY4 .GT. 0 ) VNY4 = VALLN(NY4)
         SIGPR = VNY3 - VNY4
C--> OPEEM BXOHE HAPEH   T=TN+H0
         VNY1 = 0.0
         IF( NY1 .GT. 0 ) VNY1 = VALLN1(NY1)
         VNY2 = 0.0
         IF( NY2 .GT. 0 ) VNY2 = VALLN1(NY2)
         SIGIN1 = VNY1 - VNY2
         VNY3 = 0.0
         IF( NY3 .GT. 0 ) VNY3 = VALLN1(NY3)
         VNY4 = 0.0
         IF( NY4 .GT. 0 ) VNY4 = VALLN1(NY4)
         SIGPR1 = VNY3 - VNY4
C----------------------------------------------------------------------
C   AHE PACET  MOE KOMAPATOPA(2) POBOTC TAKE
C   KAK   MOE KOMAPATOPA(1), OTOM EPEXOM HA METK 641.
C----------------------------------------------------------------------
         GO TO 641
C######################################################################
C
C       BOMOHE CTAHAPTHE CTA.
C
C######################################################################
661      CONTINUE
C--->  BXOHO CHA HA AE HE MEHETC.
C----------------------------------------------------------------------
         RMSW(10) = TN + H0
         ITOK = MSW(7)
         TOKN1(ITOK) = TOKN(ITOK)
         TOKN1(ITOK+1) = 0.0
         IF( TOKN1(ITOK) .LE. 0.5 ) TOKN1(ITOK+1) = 1.0
         TOKN1(ITOK+2) = TN + H0
         MSW(11) = 0
         KOD = 0
         RETURN
C======================================================================
662      CONTINUE
C-->   CHA HA BXOE P  T=TIME  CTA PABHM  "1".
C----------------------------------------------------------------------
         RMSW(10) = TIME
         ITOK = MSW(7)
         TOKN1(ITOK) = 1.
         TOKN1(ITOK + 1 ) = 0.
         TOKN1(ITOK + 2 ) = TIME
         MSW(11) = 1
         KOD = 0
         RETURN
C======================================================================
663      CONTINUE
C-->   CHA HA BXOE P  T=TIME  CTA PABHM  "0".
C----------------------------------------------------------------------
         RMSW(10) = TIME
         ITOK = MSW(7)
         TOKN1(ITOK) = 0.
         TOKN1(ITOK + 1 ) = 1.
         TOKN1(ITOK + 2 ) = TIME
         MSW(11) = 1
         KOD = 0
         RETURN
C######################################################################
500      CONTINUE
C===> KCA CMEH COCTOH BXOHOO CHAA......ZAPROS = 4
C---->  HET  HEOXOMOCT POBECT CMEH COCTOH BX.CHAA..?
C@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
        KOD = 0
        IF ( MSW(11) .EQ. 0 ) GO TO 510
C@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
C       EC TXG   "PMEPHO" PABHO TX=MOE, TO CMEHA HHA!
         TX   = RMSW(10)
         EPST = ABS( TX   - TXG )
C----->   (TX - TXG) = [ (TN+HX) - (TN+HXG) ]
         IF ( EPST .GT. EPSKOM ) GO TO 510
C===> HAE CMEHM COCTOHE....
         ITOK = MSW(7)
         TOKN1(ITOK+2) = TXG
C!!!-------------------------------------------------------------------
         IF ( FTEST .GE. 1 ) WRITE(NWTRE,501) MSW(1),TOKN1(ITOK),TN,TXG
501     FORMAT(' ***FTEST_1: B -TE #',I5, ' CHA  CTA =',F2.0,
     =          ' TN = ', E12.5, ' TXG = ', E12.5, ' ***')
C!!!-------------------------------------------------------------------
         RETURN
C$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
510      CONTINUE
C--->  BX. CHA HE MEHC.
         ITOK = MSW(7)
         TOKN1(ITOK) = TOKN(ITOK)
         TOKN1(ITOK+1) = 0.0
         IF( TOKN1(ITOK) .LE. 0.5 ) TOKN1(ITOK+1) = 1.0
         TOKN1(ITOK+2) = TXG
         RETURN
C----------------------------------------------------------------------
         END
